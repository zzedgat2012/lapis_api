# Database Configuration Guide

This document explains how to configure and switch between different database systems in this Lapis application.

> **Related Documentation:**
> - [1. Development](1.%20Development.md) - Development workflow
> - [2. Api](2.%20Api.md) - API endpoints that use the database
> - [4. Testing](4.%20Testing.md) - Testing with different databases

## Overview

The application supports multiple database backends:

- **SQLite** (default for development) - File-based, no server required
- **PostgreSQL** (recommended for production) - Full-featured relational database
- **MySQL** (alternative) - Popular relational database
- **Redis** (optional) - For caching and sessions

## Default Configuration (SQLite)

SQLite is enabled by default in `config.lua`:

```lua
config("development", {
  sqlite = {
    database = "/app/.dockerjunk/development.db"
  }
})
```

**Benefits:**
- ✅ Zero configuration
- ✅ No separate server needed
- ✅ Perfect for development/testing
- ✅ Data persists across restarts
- ✅ Works with hot-reload (`code_cache = "off"`)

**Location:** Database file is stored in `.dockerjunk/development.db` (gitignored)

## Switching to PostgreSQL

### 1. Update config.lua

Uncomment the PostgreSQL section in `config.lua`:

```lua
config("development", {
  postgres = {
    host = os.getenv("PGHOST") or "localhost",
    port = os.getenv("PGPORT") or "5432",
    user = os.getenv("PGUSER") or "postgres",
    password = os.getenv("PGPASSWORD") or "postgres",
    database = os.getenv("PGDATABASE") or "legal_api"
  }
})
```

### 2. Install PostgreSQL Driver

Update `Dockerfile`:

```dockerfile
RUN /usr/local/openresty/luajit/bin/luarocks install pgmoon
```

### 3. Add PostgreSQL Service

Update `docker-compose.yml`:

```yaml
services:
  web:
    # ... existing config ...
    depends_on:
      - db
    environment:
      - LAPIS_ENV=development
      - PGHOST=db
      - PGUSER=postgres
      - PGPASSWORD=postgres
      - PGDATABASE=legal_api

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: legal_api
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  postgres_data:
```

### 4. Update Application Code

If using the modular `db/init.lua`:

```lua
local DB = require("db.init")
local db = DB.init()  -- Auto-detects PostgreSQL from config
```

### 5. Rebuild and Start

```bash
docker compose build
docker compose up
```

## Switching to MySQL

### 1. Update config.lua

Uncomment the MySQL section:

```lua
config("development", {
  mysql = {
    host = os.getenv("MYSQL_HOST") or "localhost",
    port = os.getenv("MYSQL_PORT") or "3306",
    user = os.getenv("MYSQL_USER") or "root",
    password = os.getenv("MYSQL_PASSWORD") or "root",
    database = os.getenv("MYSQL_DATABASE") or "legal_api"
  }
})
```

### 2. Install MySQL Driver

Update `Dockerfile`:

```dockerfile
RUN /usr/local/openresty/luajit/bin/luarocks install lua-resty-mysql
```

### 3. Add MySQL Service

Update `docker-compose.yml`:

```yaml
  db:
    image: mysql:8
    environment:
      MYSQL_DATABASE: legal_api
      MYSQL_USER: lapis
      MYSQL_PASSWORD: lapis
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

volumes:
  mysql_data:
```

## Adding Redis (Caching/Sessions)

### 1. Update config.lua

Uncomment the Redis section:

```lua
config("development", {
  redis = {
    host = os.getenv("REDIS_HOST") or "localhost",
    port = os.getenv("REDIS_PORT") or "6379",
    password = os.getenv("REDIS_PASSWORD") or nil,
    db = os.getenv("REDIS_DB") or "0"
  }
})
```

### 2. Install Redis Driver

```dockerfile
RUN /usr/local/openresty/luajit/bin/luarocks install lua-resty-redis
```

### 3. Add Redis Service

```yaml
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  redis_data:
```

### 4. Use Redis in Application

```lua
local redis = require("resty.redis")
local config = require("lapis.config").get()

local red = redis:new()
red:set_timeout(1000)

local ok, err = red:connect(config.redis.host, config.redis.port)
if not ok then
  ngx.log(ngx.ERR, "Failed to connect to Redis: ", err)
  return
end

-- Use Redis
red:set("key", "value")
local value = red:get("key")
```

## Environment Variables

All database configurations support environment variables:

### PostgreSQL

```bash
export PGHOST=db
export PGPORT=5432
export PGUSER=postgres
export PGPASSWORD=secret
export PGDATABASE=legal_api
```

### MySQL

```bash
export MYSQL_HOST=db
export MYSQL_PORT=3306
export MYSQL_USER=lapis
export MYSQL_PASSWORD=secret
export MYSQL_DATABASE=legal_api
```

### Redis

```bash
export REDIS_HOST=redis
export REDIS_PORT=6379
export REDIS_PASSWORD=secret
export REDIS_DB=0
```

## Production Recommendations

### Database Choice

**PostgreSQL** is recommended for production:

- ✅ ACID compliant
- ✅ Advanced features (JSON, full-text search)
- ✅ Excellent performance
- ✅ Strong community support
- ✅ Better than MySQL for complex queries

### Production Config

```lua
config("production", {
  code_cache = "on",  -- Always enabled
  num_workers = "4",  -- Match CPU cores
  
  postgres = {
    host = os.getenv("PGHOST"),
    port = os.getenv("PGPORT") or "5432",
    user = os.getenv("PGUSER"),
    password = os.getenv("PGPASSWORD"),
    database = os.getenv("PGDATABASE")
  },
  
  redis = {
    host = os.getenv("REDIS_HOST"),
    port = os.getenv("REDIS_PORT") or "6379",
    password = os.getenv("REDIS_PASSWORD")
  }
})
```

### Security Checklist

- [ ] Use environment variables for sensitive data
- [ ] Never commit passwords to git
- [ ] Use SSL/TLS for database connections
- [ ] Restrict database access to specific IPs
- [ ] Use strong passwords (min 16 characters)
- [ ] Enable connection pooling
- [ ] Set up database backups
- [ ] Monitor database performance

## Troubleshooting

### SQLite: Database Locked

```
Error: database is locked
```

**Solution:** SQLite doesn't handle concurrent writes well. Switch to PostgreSQL for production.

### PostgreSQL: Connection Refused

```
Error: connection refused
```

**Check:**
1. Is PostgreSQL service running? `docker compose ps`
2. Are environment variables correct? `docker compose config`
3. Is the host correct? Use `db` (service name) not `localhost`

### MySQL: Authentication Failed

```
Error: Access denied for user
```

**Solution:** Check MySQL version (8+ requires different auth):

```yaml
  db:
    image: mysql:8
    command: --default-authentication-plugin=mysql_native_password
```

### Redis: Connection Timeout

```
Error: timeout
```

**Solution:** Increase timeout in code:

```lua
red:set_timeout(3000)  -- 3 seconds
```

## Database Migrations

For schema changes, use Lapis migrations:

```lua
-- migrations/001_create_users.lua
local schema = require("lapis.db.schema")

return {
  [1] = function()
    schema.create_table("users", {
      { "id", schema.types.serial },
      { "name", schema.types.varchar },
      { "email", schema.types.varchar },
      { "created_at", schema.types.time },
      "PRIMARY KEY (id)"
    })
    
    schema.add_index("users", "email", { unique = true })
  end
}
```

Run migrations:

```bash
docker compose exec web lapis migrate
```

## Performance Tips

### Connection Pooling

For PostgreSQL/MySQL:

```lua
-- In nginx.conf
lua_socket_pool_size 30;

-- Or in code
pg:set_keepalive(10000, 100)  -- 10s timeout, 100 connections
```

### Prepared Statements

```lua
-- SQLite
local stmt = db:prepare("SELECT * FROM users WHERE email = ?")
stmt:bind_values(email)

-- PostgreSQL
local result = pg:query("SELECT * FROM users WHERE email = $1", email)
```

### Indexing

```sql
-- Add indexes for frequently queried columns
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
```

## Resources

- [Lapis Database Documentation](https://leafo.net/lapis/reference/database.html)
- [pgmoon (PostgreSQL)](https://github.com/leafo/pgmoon)
- [lua-resty-mysql](https://github.com/openresty/lua-resty-mysql)
- [lua-resty-redis](https://github.com/openresty/lua-resty-redis)
- [SQLite Documentation](https://www.sqlite.org/docs.html)
