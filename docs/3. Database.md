# Database Configuration Guide

This guide explains how to configure and switch between the supported database engines for the Lapis application.

> **Related Documentation:**
> - [1. Development](1.%20Development.md) - Development workflow
> - [2. Api](2.%20Api.md) - API endpoints that use the database
> - [4. Testing](4.%20Testing.md) - Testing with different databases

## Overview

The application can run against several backends via the `DB_CONNECTION` environment variable:

- **sqlite** *(default)* – zero-configuration, file-based database
- **postgres** – recommended for production workloads
- **mysql** – alternative relational database option
- **redis** *(optional)* – caching/session store (configured independently)

> ℹ️ Drivers for SQLite, PostgreSQL (`pgmoon`) and MySQL (`lua-resty-mysql`) are pre-installed in the container image. You only need to point the app at the desired engine and supply the matching connection variables.

## Default Configuration (MySQL)

When `DB_CONNECTION` is unset (or set to `mysql`), the application connects to the bundled MySQL service defined in `docker-compose.yml`:

```lua
config("development", {
  mysql = {
    host = os.getenv("MYSQL_HOST") or "mysql",
    port = os.getenv("MYSQL_PORT") or "3306",
    user = os.getenv("MYSQL_USER") or "lapis",
    password = os.getenv("MYSQL_PASSWORD") or "lapis",
    database = os.getenv("MYSQL_DATABASE") or "legal_api",
    backend = "resty"
  }
})
```

**Benefits:**

- ✅ Matches production-like relational capabilities
- ✅ Service is managed automatically via Docker Compose
- ✅ Uses `lua-resty-mysql` for native OpenResty performance
- ✅ Compatible with existing migrations and Lapis tooling

Start the stack with `docker compose up -d`. Run `make migrate` the first time to set up the schema.

## Switching to PostgreSQL

Follow these steps whenever you want to develop or test against PostgreSQL:

1. **Set the engine selector**

    ```bash
    export DB_CONNECTION=postgres
    ```

1. **Provide connection variables** – the defaults below match the optional service shipped in `docker-compose.yml`:

    ```bash
    export PGHOST=postgres
    export PGPORT=5432
    export PGUSER=postgres
    export PGPASSWORD=postgres
    export PGDATABASE=legal_api
    ```

1. **Start the stack with the postgres profile** – the profile spins up both the application and the Postgres container:

    ```bash
    docker compose --profile postgres up -d web postgres
    ```

1. **Run migrations** (if needed):

    ```bash
    docker compose --profile postgres exec web lapis migrate
    ```

## Switching to SQLite

1. **Set the engine selector**

  ```bash
  export DB_CONNECTION=sqlite
  ```

1. **Stop the MySQL service (optional)** – only if you do not need it running:

  ```bash
  docker compose stop mysql
  ```

1. **Restart the web container** so it opens a SQLite connection:

  ```bash
  docker compose up -d web
  ```

SQLite stores data under `.dockerjunk/development.db` and requires no additional services.

## Adding Redis (Caching/Sessions)

### 1. Update config.lua

Uncomment the Redis section:

```lua
config("development", {
  redis = {
    host = os.getenv("REDIS_HOST") or "localhost",
    port = os.getenv("REDIS_PORT") or "6379",
    password = os.getenv("REDIS_PASSWORD") or nil,
    db = os.getenv("REDIS_DB") or "0"
  }
})
```

### 2. Install Redis Driver

```dockerfile
RUN /usr/local/openresty/luajit/bin/luarocks install lua-resty-redis
```

### 3. Add Redis Service

```yaml
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  redis_data:
```

### 4. Use Redis in Application

```lua
local redis = require("resty.redis")
local config = require("lapis.config").get()

local red = redis:new()
red:set_timeout(1000)

local ok, err = red:connect(config.redis.host, config.redis.port)
if not ok then
  ngx.log(ngx.ERR, "Failed to connect to Redis: ", err)
  return
end

-- Use Redis
red:set("key", "value")
local value = red:get("key")
```

## Environment Variables

The following environment variables are consumed by `config.lua`:

| Engine | Required Variables | Notes |
| --- | --- | --- |
| mysql | `DB_CONNECTION=mysql` *(default)*, `MYSQL_HOST`, `MYSQL_PORT`, `MYSQL_USER`, `MYSQL_PASSWORD`, `MYSQL_DATABASE` | Host/user/password default to the Compose service values |
| postgres | `DB_CONNECTION=postgres`, `PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD`, `PGDATABASE` | Port/name default to `5432`/`legal_api` if unset |
| sqlite | `DB_CONNECTION=sqlite` | No extra variables needed |
| redis | `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`, `REDIS_DB` | `DB_CONNECTION` does not affect Redis |

Set these variables in your shell, `.env` file, or Compose service definition before starting the stack.

## Production Recommendations

### Database Choice

**PostgreSQL** is recommended for production:

- ✅ ACID compliant
- ✅ Advanced features (JSON, full-text search)
- ✅ Excellent performance
- ✅ Strong community support
- ✅ Better than MySQL for complex queries

### Production Config

```lua
config("production", {
  code_cache = "on",
  num_workers = os.getenv("NGINX_WORKERS") or "4",

  postgres = {
    host = os.getenv("PGHOST"),
    port = os.getenv("PGPORT") or "5432",
    user = os.getenv("PGUSER"),
    password = os.getenv("PGPASSWORD"),
    database = os.getenv("PGDATABASE")
  },

  redis = {
    host = os.getenv("REDIS_HOST"),
    port = os.getenv("REDIS_PORT") or "6379",
    password = os.getenv("REDIS_PASSWORD")
  }
})
```

### Security Checklist

- [ ] Use environment variables for sensitive data
- [ ] Never commit passwords to git
- [ ] Use SSL/TLS for database connections
- [ ] Restrict database access to specific IPs
- [ ] Use strong passwords (min 16 characters)
- [ ] Enable connection pooling
- [ ] Set up database backups
- [ ] Monitor database performance

## Troubleshooting

### SQLite: Database Locked

```text
Error: database is locked
```

**Solution:** SQLite doesn't handle concurrent writes well. Switch to PostgreSQL for production.

### PostgreSQL: Connection Refused

```text
Error: connection refused
```

**Check:**

1. Is PostgreSQL service running? `docker compose ps`
2. Are environment variables correct? `docker compose config`
3. Is the host correct? Use `db` (service name) not `localhost`

### MySQL: Authentication Failed

```text
Error: Access denied for user
```

**Solution:** Check MySQL version (8+ requires different auth):

```yaml
  db:
    image: mysql:8
    command: --default-authentication-plugin=mysql_native_password
```

### Redis: Connection Timeout

```text
Error: timeout
```

**Solution:** Increase timeout in code:

```lua
red:set_timeout(3000)  -- 3 seconds
```

## Database Migrations

For schema changes, rely on standard Lapis migrations. Define each migration as a numbered function:

```lua
-- migrations/001_create_users.lua
local schema = require("lapis.db.schema")

return {
  [1] = function()
    schema.create_table("users", {
      { "id", schema.types.serial },
      { "name", schema.types.varchar },
      { "email", schema.types.varchar },
      { "created_at", schema.types.time },
      "PRIMARY KEY (id)"
    })
    
    schema.add_index("users", "email", { unique = true })
  end
}
```

Run migrations after switching databases to ensure the target engine has the expected schema:

```bash
docker compose exec web lapis migrate
```

## Performance Tips

### Connection Pooling

For PostgreSQL/MySQL:

```lua
-- In nginx.conf
lua_socket_pool_size 30;

-- Or in code
pg:set_keepalive(10000, 100)  -- 10s timeout, 100 connections
```

### Prepared Statements

```lua
-- SQLite
local stmt = db:prepare("SELECT * FROM users WHERE email = ?")
stmt:bind_values(email)

-- PostgreSQL
local result = pg:query("SELECT * FROM users WHERE email = $1", email)
```

### Indexing

```sql
-- Add indexes for frequently queried columns
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
```

## Resources

- [Lapis Database Documentation](https://leafo.net/lapis/reference/database.html)
- [pgmoon (PostgreSQL)](https://github.com/leafo/pgmoon)
- [lua-resty-mysql](https://github.com/openresty/lua-resty-mysql)
- [lua-resty-redis](https://github.com/openresty/lua-resty-redis)
- [SQLite Documentation](https://www.sqlite.org/docs.html)
