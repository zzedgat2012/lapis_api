# API Documentation

Complete API reference for the Users CRUD service.

> **Related Documentation:**
> - [1. Development](1.%20Development.md) - Development setup and workflow
> - [3. Database](3.%20Database.md) - Database configuration
> - [4. Testing](4.%20Testing.md) - How to test these endpoints

## Base URL

```
http://localhost:8080
```

## OpenAPI Specification

The full OpenAPI 3.0 description for this API is available at:

```http
GET /openapi.json
```

Use this document to generate API clients, interactive documentation (e.g., Swagger UI), or automated integration tests.

## Response Format

All responses follow this JSON structure:

### Success Response

```json
{
  "success": true,
  "data": { ... }
}
```

### Error Response

```json
{
  "success": false,
  "error": "Error message description"
}
```

## HTTP Status Codes

| Code | Meaning | Usage |
|------|---------|-------|
| 200 | OK | Successful GET, PUT, DELETE |
| 201 | Created | Successful POST |
| 400 | Bad Request | Validation failed, missing fields |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate email |
| 500 | Server Error | Unexpected error |

---

## Endpoints

### 1. List All Users

Retrieve all users in the system.

**Request:**

```http
GET /users
```

**Response (200 OK):**

```json
{
  "success": true,
  "count": 2,
  "users": [
    {
      "id": 1,
      "name": "Alice Smith",
      "email": "alice@example.com"
    },
    {
      "id": 2,
      "name": "Bob Johnson",
      "email": "bob@example.com"
    }
  ]
}
```

**Example:**

```bash
curl http://localhost:8080/users
```

---

### 2. Get User by ID

Retrieve a specific user by their ID.

**Request:**

```http
GET /users/:id
```

**Parameters:**

| Name | Type | Location | Description |
|------|------|----------|-------------|
| id | integer | path | User ID |

**Response (200 OK):**

```json
{
  "success": true,
  "user": {
    "id": 1,
    "name": "Alice Smith",
    "email": "alice@example.com"
  }
}
```

**Response (404 Not Found):**

```json
{
  "success": false,
  "error": "User not found"
}
```

**Examples:**

```bash
# Success
curl http://localhost:8080/users/1

# Not found
curl http://localhost:8080/users/999
```

---

### 3. Create User

Create a new user.

**Request:**

```http
POST /users
Content-Type: application/json
```

**Body Parameters:**

| Name | Type | Required | Description |
|------|------|----------|-------------|
| name | string | Yes | User's full name |
| email | string | Yes | User's email (must be unique) |

**Request Body:**

```json
{
  "name": "Charlie Brown",
  "email": "charlie@example.com"
}
```

**Response (201 Created):**

```json
{
  "success": true,
  "user": {
    "id": 3,
    "name": "Charlie Brown",
    "email": "charlie@example.com"
  }
}
```

**Response (400 Bad Request - Missing Fields):**

```json
{
  "success": false,
  "error": "Name and email are required"
}
```

**Response (409 Conflict - Duplicate Email):**

```json
{
  "success": false,
  "error": "Email already exists"
}
```

**Examples:**

```bash
# Success
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{"name": "Charlie Brown", "email": "charlie@example.com"}'

# Missing fields
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{"name": "Charlie Brown"}'

# Duplicate email
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{"name": "Alice Clone", "email": "alice@example.com"}'
```

---

### 4. Update User

Update an existing user's information.

**Request:**

```http
PUT /users/:id
Content-Type: application/json
```

**Parameters:**

| Name | Type | Location | Description |
|------|------|----------|-------------|
| id | integer | path | User ID |

**Body Parameters:**

| Name | Type | Required | Description |
|------|------|----------|-------------|
| name | string | No | New user name |
| email | string | No | New email (must be unique) |

**Request Body:**

```json
{
  "name": "Alice Johnson",
  "email": "alice.johnson@example.com"
}
```

**Response (200 OK):**

```json
{
  "success": true,
  "user": {
    "id": 1,
    "name": "Alice Johnson",
    "email": "alice.johnson@example.com"
  }
}
```

**Response (404 Not Found):**

```json
{
  "success": false,
  "error": "User not found"
}
```

**Response (409 Conflict - Email Taken):**

```json
{
  "success": false,
  "error": "Email already exists"
}
```

**Examples:**

```bash
# Update name
curl -X PUT http://localhost:8080/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name": "Alice Johnson"}'

# Update email
curl -X PUT http://localhost:8080/users/1 \
  -H "Content-Type: application/json" \
  -d '{"email": "alice.new@example.com"}'

# Update both
curl -X PUT http://localhost:8080/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name": "Alice Johnson", "email": "alice.johnson@example.com"}'

# User not found
curl -X PUT http://localhost:8080/users/999 \
  -H "Content-Type: application/json" \
  -d '{"name": "Nobody"}'
```

---

### 5. Delete User

Delete a user from the system.

**Request:**

```http
DELETE /users/:id
```

**Parameters:**

| Name | Type | Location | Description |
|------|------|----------|-------------|
| id | integer | path | User ID |

**Response (200 OK):**

```json
{
  "success": true,
  "message": "User deleted successfully"
}
```

**Response (404 Not Found):**

```json
{
  "success": false,
  "error": "User not found"
}
```

**Examples:**

```bash
# Success
curl -X DELETE http://localhost:8080/users/1

# Not found
curl -X DELETE http://localhost:8080/users/999
```

---

## Validation Rules

### Email

- Must be provided for user creation
- Must be unique across all users
- No format validation currently (can be added)

### Name

- Must be provided for user creation
- Can be any non-empty string
- No length restrictions currently

---

## Error Handling

### Common Errors

**1. Invalid JSON:**

```bash
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d 'invalid json'
```

This will return a Lapis error page.

**2. Missing Content-Type:**

```bash
curl -X POST http://localhost:8080/users \
  -d '{"name": "Test", "email": "test@example.com"}'
```

Lapis may not parse the JSON correctly.

**3. Wrong HTTP Method:**

```bash
curl -X PATCH http://localhost:8080/users/1
```

Returns 404 (route not defined).

---

## Complete Workflow Example

```bash
# 1. List all users (should show initial data)
curl http://localhost:8080/users | jq

# 2. Create a new user
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{"name": "Charlie Brown", "email": "charlie@example.com"}' | jq

# 3. Get the new user (assuming ID is 3)
curl http://localhost:8080/users/3 | jq

# 4. Update the user
curl -X PUT http://localhost:8080/users/3 \
  -H "Content-Type: application/json" \
  -d '{"name": "Charles Brown", "email": "charles@example.com"}' | jq

# 5. List all users again (should show updated data)
curl http://localhost:8080/users | jq

# 6. Delete the user
curl -X DELETE http://localhost:8080/users/3 | jq

# 7. Verify deletion
curl http://localhost:8080/users/3 | jq
# Should return 404
```

---

## Testing Tips

### Use jq for Pretty Output

```bash
curl http://localhost:8080/users | jq
```

### Save Response to File

```bash
curl http://localhost:8080/users > response.json
```

### View Response Headers

```bash
curl -i http://localhost:8080/users
```

### Verbose Output (Debug)

```bash
curl -v http://localhost:8080/users
```

---

## Future Enhancements

### Planned Features

- [ ] Pagination (`GET /users?page=1&limit=10`)
- [ ] Filtering (`GET /users?email=alice@example.com`)
- [ ] Sorting (`GET /users?sort=name&order=asc`)
- [ ] Search (`GET /users?q=alice`)
- [ ] Authentication (JWT tokens)
- [ ] Rate limiting
- [ ] Field validation (email format, name length)
- [ ] PATCH support (partial updates)
- [ ] Batch operations
- [ ] Soft deletes

### Authentication (Coming Soon)

```http
POST /auth/login
{
  "email": "alice@example.com",
  "password": "secret123"
}

Response:
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIs..."
}

Then use in requests:
GET /users
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

---

## Contributing

When adding new endpoints:

1. Follow the same response format
2. Use appropriate HTTP status codes
3. Add validation for required fields
4. Document in this file
5. Add tests in `tests/` (see [4. Testing](4.%20Testing.md))
6. Update `project-requirements.md` if needed

---

## Support

For issues or questions:

- Check [1. Development](1.%20Development.md) for setup help
- Check [4. Testing](4.%20Testing.md) for test examples
- Check [3. Database](3.%20Database.md) for database issues
- Review error logs in `.dockerjunk/logs/error.log`
